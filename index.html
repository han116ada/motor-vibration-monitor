<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Motor Titreşim İzleme Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    header {
      padding: 20px 40px;
      border-bottom: 1px solid #1f2937;
    }
    h1 {
      margin: 0;
      font-size: 24px;
    }
    .content {
      padding: 20px 40px;
      max-width: 1000px;
      margin: 0 auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 8px 6px;
      text-align: left;
    }
    th {
      background: #020617;
    }
    .status-ok {
      color: #22c55e;
      font-weight: 600;
    }
    .status-bad {
      color: #ef4444;
      font-weight: 600;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #4b5563;
    }
    .refresh-btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #3b82f6;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      margin-top: 10px;
    }
    #lastStatus {
      margin-top: 10px;
      font-size: 15px;
    }
    .chart-container {
      margin-top: 30px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid #1f2937;
      background: #020617;
    }
    .chart-container h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 10px;
    }
    canvas {
      width: 100%;
      max-height: 350px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Akıllı Motor Titreşim İzleme Paneli</h1>
  </header>

  <div class="content">
    <p>
      Bu panel, ESP32 + ADXL345 ile ölçülen <strong>titreşim seviyesini</strong> göstermektedir.
      Veriler Wi-Fi üzerinden ThingSpeak'e gönderilir, bu sayfa da ThingSpeak API'sinden
      JSON formatında çekerek tablo ve grafikte gösterir.
    </p>

    <button class="refresh-btn" onclick="loadData()">Veriyi Yenile</button>
    <p id="lastStatus"></p>

    <table>
      <thead>
        <tr>
          <th>Zaman</th>
          <th>Titreşim Seviyesi (field1)</th>
          <th>Durum</th>
        </tr>
      </thead>
      <tbody id="dataTableBody">
        <!-- JS buraya satır ekleyecek -->
      </tbody>
    </table>

    <div class="chart-container">
      <h2>Zamana Göre Titreşim Grafiği</h2>
      <p style="font-size:13px;color:#9ca3af;">
        Aşağıdaki grafikte son ölçümlerin titreşim seviyeleri gösterilmektedir.
        Sensör sallandığında veya titreşim arttığında grafik yukarı doğru spike yapar.
      </p>
      <canvas id="vibrationChart"></canvas>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ======= BURALARI KENDİ KANALINA GÖRE AYARLA =======
    const CHANNEL_ID = "YOUR_CHANNEL_ID"; // <-- ThingSpeak Channel ID
    const LIMIT = 40;                     // Son 40 ölçümü çizelim
    const THRESHOLD = 50;                 // ESP32 kodundaki THRESHOLD ile aynı olsun
    // ===================================================

    let vibrationChart = null;

    async function loadData() {
      const tbody = document.getElementById("dataTableBody");
      const lastStatus = document.getElementById("lastStatus");
      tbody.innerHTML = "<tr><td colspan='3'>Yükleniyor...</td></tr>";
      lastStatus.innerHTML = "";

      try {
        const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${LIMIT}`;
        const res = await fetch(url);
        const data = await res.json();

        tbody.innerHTML = "";

        if (!data.feeds || data.feeds.length === 0) {
          tbody.innerHTML = "<tr><td colspan='3'>Veri bulunamadı.</td></tr>";
          return;
        }

        // Grafik için array'ler
        const labels = [];
        const values = [];

        data.feeds.forEach(feed => {
          const value = parseFloat(feed.field1);
          const time = new Date(feed.created_at);

          let statusText = "-";
          let statusClass = "";

          if (!isNaN(value)) {
            // Tablo için durum
            if (value > THRESHOLD) {
              statusText = "Bakım Zamanı";
              statusClass = "status-bad";
            } else {
              statusText = "Motor OK";
              statusClass = "status-ok";
            }

            // Grafik için verileri doldur
            labels.push(time.toLocaleTimeString()); // sadece saat/dakika
            values.push(value);
          }

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${time.toLocaleString()}</td>
            <td>${isNaN(value) ? "-" : value.toFixed(2)}</td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
          `;
          tbody.appendChild(tr);
        });

        // Son veriye göre genel durum
        const last = data.feeds[data.feeds.length - 1];
        const lastValue = parseFloat(last.field1);
        if (!isNaN(lastValue)) {
          if (lastValue > THRESHOLD) {
            lastStatus.innerHTML = `Son durum: <span class="status-bad">Bakım Zamanı</span>`;
          } else {
            lastStatus.innerHTML = `Son durum: <span class="status-ok">Motor OK</span>`;
          }
        }

        // Grafiği güncelle
        updateChart(labels, values);

      } catch (err) {
        console.error(err);
        tbody.innerHTML = "<tr><td colspan='3'>Veri çekilirken hata oluştu.</td></tr>";
        lastStatus.innerText = "Sunucuya erişilemiyor.";
      }
    }

    function updateChart(labels, values) {
      const ctx = document.getElementById('vibrationChart').getContext('2d');

      // Grafik daha önce oluşturulduysa, sadece datasını güncelle
      if (vibrationChart) {
        vibrationChart.data.labels = labels;
        vibrationChart.data.datasets[0].data = values;
        vibrationChart.update();
        return;
      }

      // İlk defa grafik oluşturuluyor
      vibrationChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Titreşim Seviyesi',
            data: values,
            fill: false,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: '#e5e7eb'
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#9ca3af' },
              grid: { color: '#1f2937' }
            },
            y: {
              ticks: { color: '#9ca3af' },
              grid: { color: '#1f2937' }
            }
          }
        }
      });
    }

    // Sayfa açılır açılmaz veriyi al ve grafiği çiz
    loadData();
  </script>
</body>
</html>

